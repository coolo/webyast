<!doctype html public "-//w3c//dtd html 4.0 transitional//en">
<html>
<head>
   <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
   <meta name="GENERATOR" >
   <title>YaST Webservice Configuration</title>
   <script src="javascripts/prettify.js" type="text/javascript" onerror="alert('Error: failed to load ' + this.src)"></script>
   <link rel="stylesheet" type="text/css" href="stylesheets/prettify.css" />


</head>
<body onload="prettyPrint()" text="#000000" bgcolor="#FFFFFF" link="#0000EE" vlink="#551A8B" alink="#FF0000">

<h1>YaST Webservice Configuration</h1>

<hr WIDTH="100%">

<h3>Installation and Configuration</h3>

<p><br>All configurations should be done in the POST install section of the package.

<p>After you have installed the package an own lighttpd server with the 
YaST-Webservice has been configured which is running with the 
system account "yastws".
This HTTP server is configured as "localhost" only which has the port 8080.
This can be changed in the file /etc/yastws/lighttpd.conf</p>

<p>So, you can start the server with:

<pre class="prettyprint">
rcyastws start
</pre>

<p>Use the webbrowser with the URL <a href="http://localhost:8080"> http://localhost:8080</a>

<p>Login as "root". While the package installation all access rights has been
granted to "root". For another users you will have to grant permission as
descibed in the following sections:</p>

<hr/>

<h3>API Policies</h3>

<p>Each YaST Webservice call has concerning access permissions which can be defined for each user.</p>
<p>These permissions are handled by PolicyKit in the file:</p>

<p>/usr/share/PolicyKit/policy/org.opensuse.yast.webservice.policy</p>

<p>If you are getting a permission error while using the API just have a look to the webserver logfile in order to get the information which permissions are missed:</p>

<pre class="prettyprint">
Action: org.opensuse.yast.webservice.run-yastmodule User: schubi Result: no
Action: org.opensuse.yast.webservice.run-yastmodule-lan User: schubi Result: yes
</pre>

<p>These permissions can be set with the call "polkit-auth" like:

<pre class="prettyprint">
polkit-auth --user schubi --grant org.opensuse.yast.webservice.run-yastmodule-lan
</pre>

Or can be reset by:

<pre class="prettyprint">
polkit-auth --user schubi --revoke org.opensuse.yast.webservice.run-yastmodule-lan
</pre>

In order to cleanup or to grant ALL permissions you can use the ruby script policyKit-rights.rb delivered with this package:</p>

<pre class="prettyprint">
> policyKit-right.rb
Usage: policyKit-right.rb --user <user> --action (show|grant|revoke)
NOTE: This programm should be run by user root

This call grant/revoke ALL permissions for the YaST Webservice.
In order to grant/revoke single rights use:
polkit-auth --user <user> (--grant|-revoke) <policyname>

In order to show all possible permissions use:
polkit-action
</pre>

<hr/>

<h3>Roles</h3>

<p>In order to avoid declaring permissions for each user there is the possibility to define roles for each user like: administrator, secretary, ...</p>

<p>The definition which roles belong to a user are defined in file /etc/yast_user_roles:</p>

<pre class="prettyprint">
#
# file : /etc/yast_user_roles
#
# This file describes roles of a user accounts for the YaST Webservice
# "user accounts": System account which is accessible e.g. via PAM.
# "roles"        : Describes user accounts for which policies have
#                  been generated
#
# Format: <user>   <role 1>,<role 2>,...<role n>
#
</pre>

<p>So, you have to generate a system user e.g. "secretary" and define special right for
that user (described above).</p>
<p>For getting "secretary" rights you have to add the concerning user in the file 
/etc/yast_user_roles only.</p>

<p>This is a very simple way to store this information. Much more elegant would be to
store it to another place e.g. via ldap. Make a proposal :-)</p>

<hr/>

<h3>Hostname and Port</h3>

<p>This settings can be changed in /etc/yastws/lighttpd.conf

<pre class="prettyprint">
#######################################################################
##
##  Basic Configuration
## ---------------------
##
#server.port = 80
server.bind = "localhost"
server.port = 8080
</pre>
</p>

<hr/>

<h3>HTTPS Protocol</h3>

<h4>SSL</h4>

<p>Before we start configuring lighttpd for the YaST-webclient, we need to get an SSL certificate. If you are creating your own, you can follow the instructions from the lighttpd web site:

<pre class="prettyprint">
openssl req -new -x509 -keyout host.pem -out host.pem -days 365 -nodes
</pre>

If you already have a certificate that’s a .crt and a .key file, you have to make them snuggle up into a single .pem file:

<pre class="prettyprint">
cat host.key host.crt > host.pem
</pre>

Both of these methods result in a single .pem file, usually named host.pem where "host" is the name of the server you’re using 
the certificate for. This file can be stored anywhere you want on your system, since the lighttpd configuration takes an explicit path to it.
Normally certificates are stored in /etc/ssl/certs.</p>

<h4>Configure lighttpd</h4>

<p>Add these two entries to /etc/yastws/lighttpd.conf

<pre class="prettyprint">
ssl.engine         = "enable"
ssl.pemfile        = "/etc/ssl/certs/host.pem"
</pre>

and restart the server with:
<pre class="prettyprint">
rcyastws restart
</pre>
</p>

<p>Now you can login with HTTPS protocol.</p>

<hr/>

<h3>Make it "public" via "avahi"</h3>

<p>Avahi is a system which facilitates service discovery on a local network. So if it is enabled YaST Webclient 
evaluate all available YaST Webservices on a local network automatically and the user can select a service.</p>

<p>
In order to make your YaST Webservice "public" you only have to comment out the entry
<pre class="prettyprint">
server.bind = "localhost"
</pre>
</p>

<p>in /etc/yastws/lighttpd.conf and restart the server.</p>

<p>The startscript rcyastws make the service public while the starting procedure.</p>

<p>Note: Please be aware that your YaST Webservice is available from outside now. So you should switch to HTTPS-protocol.</p>

<hr/>

<h3>Starting YaST webservice with webrick (not required)</h3>

<p>ROR provides an own webserver called webrick. It is nice for testing but
should not used for "realtime".</p>

<p>Please start this server with the root account.</p>

<h4>Configuration of Webserver rights</h4>

<p>These rights are needed for the communication between your webserver and the
SCR agent.</p>

<p>For testing you can grant all permissions to root by adding

<pre class="prettyprint" id="xml">
&lt;?xml version="1.0"?&gt;
&lt;!DOCTYPE pkconfig PUBLIC "-//freedesktop//DTD PolicyKit Configuration 1.0//EN" "http://hal.freedesktop.org/releases/PolicyKit/1.0/config.dtd"&gt;
&lt;!-- See the manual page PolicyKit.conf(5) for file format --&gt;
&lt;config version="0.1"&gt;
  &lt;match user="root"&gt;
    &lt;match action="org.opensuse.yast.scr.*"&gt;
      &lt;return result="yes"/&gt;
    &lt;/match&gt;
  &lt;/match&gt;
  &lt;match user="root"&gt;
    &lt;match action="org.freedesktop.packagekit.system-update"&gt;
      &lt;return result="yes"/&gt;
    &lt;/match&gt;
  &lt;/match&gt;
  &lt;match user="root"&gt;
    &lt;match action="org.freedesktop.policykit.read"&gt;
      &lt;return result="yes"/&gt;
    &lt;/match&gt;
  &lt;/match&gt;
&lt;/config&gt;

</pre>

to /etc/PolicyKit/PolicyKit.conf</p>


<h4>starting</h4>

<pre class="prettyprint">
cd /etc/yastws/www/
script/server -p 3001
</pre>

<p>Logs are written to /etc/yastws/www/log</p>

<h4>first test</h4>

<p>Use the webbrowser with the URL http://0.0.0.0:3001</p>

